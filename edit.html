 <script>
      const REPO = "zunzunDeveloper/text";
      const FILE_PATH = "content.txt";
      const TOKEN = "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";

      document.addEventListener("DOMContentLoaded", async () => {
        const editor = document.getElementById("contentEditor");
        const saveBtn = document.getElementById("saveBtn");
        const status = document.getElementById("status");

        // 加载现有内容（修复GET请求）
        try {
          const response = await fetch(
            `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`,
            {
              headers: {
                Authorization: `token ${TOKEN}`,
                Accept: "application/vnd.github.v3+json"
              }
            }
          );
          
          if (!response.ok) throw new Error("获取内容失败");
          
          const data = await response.json();
          // 正确处理Base64解码和中文
          const content = decodeURIComponent(
            escape(
              atob(data.content.replace(/\s/g, ''))
            )
          );
          editor.value = content;
        } catch (error) {
          console.error("加载错误:", error);
          status.textContent = "首次使用，将创建新文件。";
        }

        // 保存到 GitHub（修复PUT请求）
        saveBtn.addEventListener("click", async () => {
          const content = editor.value;
          const message = "Update content via edit.html";

          try {
            // 先获取文件SHA（需要授权）
            let sha = null;
            try {
              const getResponse = await fetch(
                `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`,
                { 
                  headers: { 
                    Authorization: `token ${TOKEN}`,
                    Accept: "application/vnd.github.v3+json"
                  } 
                }
              );
              const getData = await getResponse.json();
              sha = getData.sha;
            } catch (e) {
              console.log("文件可能不存在，将创建新文件");
            }

            // 提交更新（确保所有请求都有授权头）
            const updateResponse = await fetch(
              `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `token ${TOKEN}`,
                  Accept: "application/vnd.github.v3+json",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  message,
                  content: btoa(unescape(encodeURIComponent(content))), // 正确处理中文编码
                  sha
                }),
              }
            );

            if (!updateResponse.ok) {
              const errorData = await updateResponse.json();
              throw new Error(errorData.message || "保存失败");
            }

            status.textContent = "✅ 保存成功！";
            setTimeout(() => {
              status.textContent = "";
            }, 3000);
          } catch (error) {
            console.error("保存错误:", error);
            status.textContent = "❌ 保存失败：" + error.message;
          }
        });
      });
    </script>
